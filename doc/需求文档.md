1. 需求文档 (PRD)
1.1 项目概述
Pika是一个基于双层智能Agent架构的个人生活自动化服务平台。系统通过上层MasterAgent理解用户意图，调度下层专业Agent执行具体任务，实现高度灵活的自然语言交互能力。第一期聚焦于健康数据自动化录入场景。

1.2 核心特性
自然语言交互：支持结构化请求和自然语言请求两种模式
智能意图识别：MasterAgent自动解析用户意图并调度对应任务
多任务扩展框架：支持轻松添加跑步、游泳等新任务类型
安全的存储架构：基于Azure Storage Account的层级文件夹结构，支持密钥管理
Azure Functions认证：使用标准的Azure Functions密钥认证机制
1.3 功能需求
核心工作流（健康数据场景）
用户iPhone快捷指令上传截图 → 调用Pika API → MasterAgent意图识别 → 
调用HealthMetricsAgent → 提取数据 → 更新Notion数据库

支持的输入格式
结构化请求（用于自动化场景）
json{
  "mode": "structured",
  "task_type": "health_metrics",
  "parameters": {
    "storage_key": "{加密的存储密钥}",
    "blob_path": "data/health/2026/01/20260117_0830.png",
    "date": "2026-01-17"
  }
}

自然语言请求（用于交互式场景）
json{
  "mode": "natural",
  "query": "我刚上传了今天早上的体重截图，在健康文件夹里，文件是8点半的那张，请处理一下"
}

1.4 非功能需求
安全认证：API使用Azure Functions标准的 x-functions-key 请求头认证
存储结构：按任务类型和日期分层的Blob存储结构，容器名为filesystem
可扩展性：新增任务只需实现新Agent类并注册到MasterAgent
错误处理：完善的错误处理和日志记录
配置管理：所有密钥通过Azure Functions环境变量管理
1.5 部署要求
部署平台：Azure Functions (Python Runtime)
认证方式：使用函数密钥认证，通过 x-functions-key 请求头传递
函数类型：HTTP触发器函数
授权级别：设置函数级别或管理员级别的密钥
2. 系统设计文档
2.1 总体架构
┌─────────────────────────────────────────────────────────┐
│                    API Gateway                           │
│  POST /api/process (支持两种请求格式)                   │
│  认证: x-functions-key请求头                           │
└──────────────┬──────────────────────────────────────────┘
               │
┌──────────────▼──────────────────────────────────────────┐
│              MasterAgent (智能调度器)                   │
│  • 解析自然语言意图                                     │
│  • 提取关键参数                                         │
│  • 调度专业Agent                                        │
└──────────────┬──────────────────────────────────────────┘
               │
    ┌──────────┴──────────┐
    │                     │
┌───▼─────┐        ┌─────▼─────┐ 未来扩展
│Health   │        │Running    │
│Metrics  │        │Log Agent  │
│Agent    │        │           │
└───┬─────┘        └───────────┘
    │
┌───▼──────────────────────────────────────────┐
│                工具层                         │
│  • Azure Storage 工具                         │
│  • OpenRouter 视觉模型工具                    │
│  • Notion API 工具                            │
└───────────────────────────────────────────────┘

2.2 安全设计 - 更新版
API层安全
认证方式：使用标准的Azure Functions密钥认证
请求头： x-functions-key （包含函数密钥）
密钥管理：
函数密钥：在Azure Portal中为函数生成和管理的密钥
主机密钥：用于访问所有函数的通用密钥（更高级别）
系统密钥：由Azure管理的密钥
环境变量配置：
bash# Azure Functions存储账户（运行所需）
AzureWebJobsStorage=DefaultEndpointsProtocol=https;AccountName=xxx;AccountKey=xxx;EndpointSuffix=core.windows.net

# API功能性密钥
Pika_API_Key=development_api_key_123

# Azure Storage
Azure_Storage_Account_Name=pikastorage
Azure_Storage_Account_Key_default=default_key_here

# AI服务
OpenRouter_API_Key=your_openrouter_key

# Notion集成
Notion_API_Key=your_notion_key
Health_Metrics_Notion_DB_ID=database_id_here
Running_Log_Notion_DB_ID=database_id_here

Azure Functions密钥类型说明
函数密钥：特定于函数的密钥，用于单个函数的认证
主机密钥：适用于函数应用中所有函数的密钥
系统密钥：由Azure Functions运行时管理的密钥
2.3 Azure Functions HTTP触发器配置
在 function.json 中配置授权级别：
json{
  "bindings": [
    {
      "authLevel": "function",  // 或 "anonymous"、"admin"
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["post"],
      "route": "api/process"
    }
  ]
}

注意：当 authLevel 设置为 function 或 admin 时，Azure Functions会自动验证 x-functions-key 或 code 查询参数。
2.4 认证流程
客户端请求 → 添加x-functions-key头 → Azure Functions运行时验证 → 
验证通过 → 执行函数代码 → 返回响应
验证失败 → 返回401未授权
2.5 Azure Storage 结构
Azure Storage 容器名为 `filesystem`，文件路径结构如下：
filesystem/
├── data/
│   ├── health/{year}/{month}/{YYYYMMDD}_{HHMM}.png
│   ├── running/{year}/{month}/{YYYYMMDD}_{HHMM}.png
│   ├── swimming/{year}/{month}/{YYYYMMDD}_{HHMM}.png
│   └── temp/
└── {task_type}/processed/{year}/{month}/  # 处理完成后的文件